<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>科幻验证系统</title>
    <style>
        /* 基础样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: linear-gradient(135deg, #0a0e2a 0%, #1a1f4b 100%);
            color: #e0e0ff;
            padding: 20px;
            min-width: 280px;
            max-width: 400px;
            margin: 0 auto;
            -webkit-user-select: none;
            user-select: none;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 主容器 */
        .scifi-container {
            width: 100%;
            background: rgba(10, 14, 42, 0.8);
            border: 1px solid #4a4fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 0 25px rgba(74, 79, 255, 0.4),
                        inset 0 0 15px rgba(74, 79, 255, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        /* 科幻边框效果 */
        .scifi-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #4a4fff, transparent);
            animation: scanline 3s linear infinite;
        }
        
        @keyframes scanline {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* 标题样式 */
        .scifi-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 16px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #4a4fff;
            text-shadow: 0 0 10px rgba(74, 79, 255, 0.7);
        }
        
        /* 公告样式 */
        .scifi-announcement {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(20, 25, 60, 0.5);
            border-radius: 8px;
            border-left: 3px solid #4a4fff;
        }
        
        /* ID显示区域 */
        .scifi-id-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }
        .scifi-id-label {
            font-size: 14px;
            color: #8a8dff;
        }
        .scifi-id-value {
            font-size: 14px;
            padding: 10px 12px;
            background: rgba(20, 25, 60, 0.7);
            border: 1px solid #4a4fff;
            border-radius: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .scifi-copy-btn {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            background: linear-gradient(135deg, #4a4fff 0%, #3136c9 100%);
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .scifi-copy-btn:hover {
            background: linear-gradient(135deg, #5a5fff 0%, #4146d9 100%);
            box-shadow: 0 0 8px rgba(74, 79, 255, 0.6);
        }
        
        /* 输入框区域 */
        .scifi-input-group {
            margin-bottom: 24px;
        }
        .scifi-input {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            background: rgba(20, 25, 60, 0.7);
            border: 1px solid #4a4fff;
            border-radius: 8px;
            outline: none;
            color: #ffffff;
            transition: all 0.3s ease;
            -webkit-user-select: text;
            user-select: text;
            -webkit-appearance: none;
        }
        .scifi-input:focus {
            border-color: #6a6fff;
            box-shadow: 0 0 12px rgba(106, 111, 255, 0.5);
        }
        .scifi-input-hint {
            font-size: 12px;
            color: #8a8dff;
            margin-top: 6px;
            padding-left: 4px;
        }
        
        /* 按钮区域 */
        .scifi-btn-group {
            display: flex;
            gap: 12px;
        }
        .scifi-btn {
            flex: 1;
            padding: 14px 0;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #4a4fff 0%, #3136c9 100%);
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .scifi-btn:hover {
            background: linear-gradient(135deg, #5a5fff 0%, #4146d9 100%);
            box-shadow: 0 0 15px rgba(74, 79, 255, 0.7);
            transform: translateY(-2px);
        }
        .scifi-btn:active {
            transform: translateY(0);
        }
        
        /* 自定义按钮 */
        .scifi-custom-btn-group {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        
        /* 加载中样式 */
        .scifi-loading {
            display: none;
            text-align: center;
            padding: 30px 0;
        }
        .scifi-loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(74, 79, 255, 0.2);
            border-top-color: #4a4fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .scifi-loading-text {
            font-size: 16px;
            color: #8a8dff;
        }
        
        /* 错误提示样式 */
        .scifi-error {
            color: #ff4a4a;
            font-size: 13px;
            margin-top: 6px;
            padding-left: 4px;
            display: none;
            text-shadow: 0 0 5px rgba(255, 74, 74, 0.5);
        }
        
        /* 颜色代码样式 */
        .color-code {
            font-weight: bold;
        }
        
        /* 粒子背景效果 */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
    </style>
</head>
<body>
    <!-- 粒子背景 -->
    <div class="particles" id="particles"></div>
    
    <!-- 加载中区域 -->
    <div class="scifi-loading" id="loading">
        <div class="scifi-loading-spinner"></div>
        <div class="scifi-loading-text">验证中...</div>
    </div>

    <!-- 主内容区域（初始隐藏） -->
    <div class="scifi-container" id="main-content" style="display: none;">
        <!-- 标题（由原生配置填充） -->
        <h1 class="scifi-title" id="dialog-title"></h1>

        <!-- 公告（由原生配置填充，可选） -->
        <div class="scifi-announcement" id="announcement"></div>

        <!-- ID显示与复制 -->
        <div class="scifi-id-group">
            <div class="scifi-id-label">设备标识码</div>
            <div class="scifi-id-value">
                <span id="device-id">加载中...</span>
                <button class="scifi-copy-btn" onclick="copyId()">复制</button>
            </div>
        </div>

        <!-- 卡密输入框 -->
        <div class="scifi-input-group">
            <input type="text" class="scifi-input" id="verify-code" placeholder="请输入访问密钥" maxlength="200" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            <div class="scifi-input-hint">密钥长度为8-200位，含字母和数字</div>
            <div class="scifi-error" id="error-message"></div>
        </div>

        <!-- 功能按钮组 -->
        <div class="scifi-btn-group">
            <button class="scifi-btn" onclick="submitVerify()">验证授权</button>
        </div>

        <!-- 自定义按钮（由原生配置控制显示/隐藏） -->
        <div class="scifi-custom-btn-group" id="custom-button-group" style="display: none;">
            <button class="scifi-btn" id="custom-button" onclick="openButtonLink()">获取密钥</button>
        </div>
    </div>

    <script>
        // 创建粒子背景
        function createParticles() {
            const container = document.getElementById('particles');
            const count = 40;
            
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.style.position = 'absolute';
                particle.style.width = Math.random() * 3 + 1 + 'px';
                particle.style.height = particle.style.width;
                particle.style.background = '#4a4fff';
                particle.style.borderRadius = '50%';
                particle.style.boxShadow = '0 0 5px #4a4fff';
                
                // 随机位置
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                
                // 动画
                const duration = Math.random() * 10 + 10;
                particle.style.animation = `float ${duration}s linear infinite`;
                
                const keyframes = `
                @keyframes float {
                    0% { transform: translate(0, 0); opacity: ${Math.random() * 0.5 + 0.2}; }
                    50% { transform: translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px); opacity: ${Math.random() * 0.5 + 0.5}; }
                    100% { transform: translate(0, 0); opacity: ${Math.random() * 0.5 + 0.2}; }
                }`;
                
                const styleSheet = document.createElement('style');
                styleSheet.textContent = keyframes;
                document.head.appendChild(styleSheet);
                
                container.appendChild(particle);
            }
        }

        // 解析颜色代码的函数
        function parseColorCodes(text) {
            // 匹配6位或3位的十六进制颜色代码
            const colorRegex = /#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})([^#]*?)(?=#|$)/g;
            let result = '';
            let lastIndex = 0;
            let match;
            
            // 如果没有颜色代码，直接返回文本
            if (!text.includes('#')) {
                return text;
            }
            
            // 遍历所有匹配项
            while ((match = colorRegex.exec(text)) !== null) {
                // 添加匹配项之前的文本
                result += text.substring(lastIndex, match.index);
                
                const colorCode = match[1];
                const content = match[2];
                
                // 如果是3位颜色代码，扩展为6位
                const fullColorCode = colorCode.length === 3 
                    ? colorCode.split('').map(c => c + c).join('')
                    : colorCode;
                
                // 创建带颜色的span
                result += `<span class="color-code" style="color: #${fullColorCode};">${content}</span>`;
                
                lastIndex = match.index + match[0].length;
            }
            
            // 添加剩余文本
            result += text.substring(lastIndex);
            
            return result;
        }

        // 初始化：等待原生配置数据，渲染页面
        window.onload = function() {
            // 创建粒子背景
            createParticles();
            
            try {
                // 调用原生接口获取配置数据（NativeBridge由HtmlDialogHelper注入）
                const configStr = window.NativeBridge.getConfigData();
                const config = JSON.parse(configStr || '{}');
                
                console.log('获取到配置:', config);
                
                // 填充配置到页面（解析颜色代码）
                const titleElement = document.getElementById('dialog-title');
                const announcementElement = document.getElementById('announcement');
                
                if (config.title) {
                    titleElement.innerHTML = parseColorCodes(config.title);
                } else {
                    titleElement.textContent = '系统访问验证';
                }
                
                if (config.announcement) {
                    announcementElement.innerHTML = parseColorCodes(config.announcement);
                } else {
                    announcementElement.textContent = '请输入您的访问密钥以完成身份验证';
                }
                
                // 显示设备ID
                if (config.deviceId) {
                    document.getElementById('device-id').textContent = config.deviceId;
                }
                
                // 控制自定义按钮显示/隐藏
                const customBtnGroup = document.getElementById('custom-button-group');
                if (config.showButton === true) {
                    customBtnGroup.style.display = 'flex';
                    
                    // 设置自定义按钮文本（如果提供了buttonText）
                    if (config.buttonText) {
                        document.getElementById('custom-button').textContent = config.buttonText;
                    }
                }
                
                // 切换到主内容（隐藏加载中）
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                
                // 自动聚焦到输入框
                setTimeout(() => {
                    const input = document.getElementById('verify-code');
                    input.focus();
                    
                    // 额外的触摸事件处理，确保移动设备键盘弹出
                    input.addEventListener('touchstart', function(e) {
                        e.stopPropagation();
                        this.focus();
                    });
                    
                    input.addEventListener('touchend', function(e) {
                        e.stopPropagation();
                        this.focus();
                    });
                    
                    input.addEventListener('click', function(e) {
                        e.stopPropagation();
                        this.focus();
                    });
                }, 300);
                
            } catch (e) {
                console.error('配置加载失败:', e);
                alert('配置加载失败：' + e.message);
                closeDialog();
            }
        };

        // 1. 复制ID到剪贴板（调用原生复制接口）
        function copyId() {
            try {
                const deviceId = document.getElementById('device-id').textContent;
                // 调用原生copyId方法
                window.NativeBridge.copyId();
                // 提示用户
                alert('设备标识码已复制：\n' + deviceId);
            } catch (e) {
                console.error('复制失败:', e);
                alert('复制失败：' + e.message);
            }
        }

        // 2. 提交卡密验证（调用原生验证接口）
        function submitVerify() {
            const verifyCode = document.getElementById('verify-code').value.trim();
            const errorElement = document.getElementById('error-message');
            
            // 隐藏之前的错误信息
            errorElement.style.display = 'none';
            
            // 前端简单校验
            if (!verifyCode) {
                showError('请输入访问密钥');
                return;
            }
            
            if (verifyCode.length < 8 || verifyCode.length > 200) {
                showError('密钥长度应为8-200位');
                return;
            }
            
            // 显示加载中
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.querySelector('.scifi-loading-text').textContent = '验证中...';
            
            // 调用原生验证接口
            try {
                window.NativeBridge.verifyInput(verifyCode);
            } catch (e) {
                console.error('验证调用失败:', e);
                // 恢复显示
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                showError('验证调用失败：' + e.message);
            }
        }

        // 显示错误信息
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // 3. 打开自定义按钮链接（调用原生链接接口）
        function openButtonLink() {
            try {
                // 调用原生openButtonLink方法
                window.NativeBridge.openButtonLink();
            } catch (e) {
                console.error('打开链接失败:', e);
                alert('打开链接失败：' + e.message);
            }
        }

        // 4. 关闭弹窗（调用原生关闭接口）
        function closeDialog() {
            try {
                window.NativeBridge.closeDialog();
            } catch (e) {
                console.error('关闭弹窗失败:', e);
                // 降级处理：直接隐藏页面
                document.body.innerHTML = '<div style="text-align:center;padding:20px;">验证系统已关闭</div>';
            }
        }

        // 防止页面滚动（但允许输入框内的滚动）
        document.addEventListener('touchmove', function(e) {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>